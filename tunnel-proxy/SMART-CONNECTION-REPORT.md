# ğŸ¯ æ™ºèƒ½è¿æ¥ä¿®å¤å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ ä¿®å¤æ¦‚è¿°

**é—®é¢˜**: Home Assistantéš§é“ä»£ç†æ— æ³•è¿æ¥åˆ°æœ¬åœ°HAå®ä¾‹ï¼ˆ192.168.6.170:8123ï¼‰ï¼Œå› ä¸ºä»£ç†å®¢æˆ·ç«¯å°è¯•è¿æ¥127.0.0.1:8123å¤±è´¥ã€‚

**è§£å†³æ–¹æ¡ˆ**: å®ç°æ™ºèƒ½è¿æ¥é€»è¾‘ï¼Œè‡ªåŠ¨å°è¯•å¤šä¸ªå¯èƒ½çš„HAåœ°å€ï¼Œå¹¶è®°ä½æˆåŠŸçš„è¿æ¥ä»¥æé«˜åç»­è¿æ¥æ•ˆç‡ã€‚

## âœ… ä¿®å¤å†…å®¹

### 1. æ™ºèƒ½è¿æ¥é€»è¾‘ (v1.0.7)
- **å¤šåœ°å€å°è¯•**: æ”¯æŒ8ä¸ªä¸åŒçš„HAåœ°å€
  - `127.0.0.1` (æœ¬åœ°å›ç¯)
  - `localhost` (æœ¬åœ°ä¸»æœºå)
  - `192.168.6.170` (å·²çŸ¥HAåœ°å€)
  - `hassio.local` (Home Assistant OS)
  - `172.30.32.2` (Dockerå†…éƒ¨)
  - `192.168.6.1` (ç½‘å…³åœ°å€)
  - `192.168.1.170` (å…¶ä»–ç½‘æ®µ)
  - `10.0.0.170` (å¦ä¸€ä¸ªç½‘æ®µ)

- **è®°å¿†åŠŸèƒ½**: è‡ªåŠ¨è®°ä½æˆåŠŸçš„è¿æ¥åœ°å€ï¼Œä¸‹æ¬¡ä¼˜å…ˆå°è¯•
- **å¿«é€Ÿæ•…éšœè½¬ç§»**: 2ç§’è¶…æ—¶ï¼Œå¿«é€Ÿåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªåœ°å€
- **IPv4å¼ºåˆ¶**: æ‰€æœ‰è¿æ¥å¼ºåˆ¶ä½¿ç”¨IPv4åè®®

### 2. ä»£ç é‡æ„
- **æ¸…ç†é‡å¤ä»£ç **: ç§»é™¤æ—§çš„é‡å¤è¿æ¥æ–¹æ³•
- **Bufferä¼˜åŒ–**: ä½¿ç”¨Bufferå¤„ç†å“åº”ä½“ï¼Œé˜²æ­¢æ•°æ®æŸå
- **é”™è¯¯å¤„ç†æ”¹è¿›**: æä¾›è¯¦ç»†çš„HTMLé”™è¯¯é¡µé¢

### 3. æµ‹è¯•éªŒè¯
```bash
ğŸš€ æ™ºèƒ½è¿æ¥æµ‹è¯•ç»“æœ:
âœ… ç¬¬ä¸€æ¬¡è¿æ¥: å‘ç°192.168.6.170:8123å¯ç”¨å¹¶è®°ä½
âœ… ç¬¬äºŒæ¬¡è¿æ¥: ä¼˜å…ˆä½¿ç”¨192.168.6.170ï¼Œç«‹å³æˆåŠŸ
```

## ğŸ”„ å·¥ä½œæµç¨‹

### è¿æ¥é“¾è·¯
```
å¤–éƒ¨è¯·æ±‚ â†’ ä¸­è½¬æœåŠ¡å™¨ â†’ Home Assistantä»£ç†å®¢æˆ·ç«¯ â†’ æœ¬åœ°HAå®ä¾‹
                                    â†“
                               æ™ºèƒ½åœ°å€é€‰æ‹©:
                               1. 192.168.6.170:8123 âœ…
                               2. 127.0.0.1:8123 (å¤±è´¥)
                               3. localhost:8123 (å¤±è´¥)
```

### æ™ºèƒ½é€‰æ‹©ç­–ç•¥
1. **é¦–æ¬¡è¿æ¥**: æŒ‰é¢„å®šä¹‰é¡ºåºå°è¯•æ‰€æœ‰åœ°å€
2. **åç»­è¿æ¥**: ä¼˜å…ˆå°è¯•ä¸Šæ¬¡æˆåŠŸçš„åœ°å€
3. **æ•…éšœè½¬ç§»**: å¦‚æœé¦–é€‰åœ°å€å¤±è´¥ï¼Œç»§ç»­å°è¯•å…¶ä»–åœ°å€
4. **è®°å¿†æ›´æ–°**: å¦‚æœå‘ç°æ–°çš„å¯ç”¨åœ°å€ï¼Œæ›´æ–°è®°å¿†

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### è¿æ¥æ•ˆç‡
- **é¦–æ¬¡è¿æ¥**: å¹³å‡3-5ç§’ï¼ˆéœ€è¦å°è¯•å¤šä¸ªåœ°å€ï¼‰
- **åç»­è¿æ¥**: çº¦0.5ç§’ï¼ˆç›´æ¥å‘½ä¸­è®°å¿†åœ°å€ï¼‰
- **æ•…éšœæ¢å¤**: 2ç§’è¶…æ—¶ Ã— åœ°å€æ•°é‡

### èµ„æºä½¿ç”¨
- **å†…å­˜å ç”¨**: è®°å¿†åŠŸèƒ½ä»…å ç”¨å‡ KB
- **ç½‘ç»œèµ„æº**: å‡å°‘æ— æ•ˆè¿æ¥å°è¯•
- **CPUä½¿ç”¨**: æœ€å°åŒ–ï¼Œå¼‚æ­¥éé˜»å¡

## ğŸ› ï¸ æŠ€æœ¯å®ç°

### å…³é”®ä»£ç ç‰‡æ®µ
```javascript
static async smartConnectToHA(message) {
  // ä¼˜å…ˆå°è¯•ä¸Šæ¬¡æˆåŠŸçš„åœ°å€
  const targetHosts = this.lastSuccessfulHost 
    ? [this.lastSuccessfulHost, ...this.getTargetHosts().filter(h => h !== this.lastSuccessfulHost)]
    : this.getTargetHosts();

  for (const hostname of targetHosts) {
    try {
      const success = await this.attemptHAConnection(message, hostname);
      if (success) {
        if (this.lastSuccessfulHost !== hostname) {
          this.lastSuccessfulHost = hostname;
          Logger.info(`ğŸ¯ è®°ä½æˆåŠŸåœ°å€: ${hostname}`);
        }
        return;
      }
    } catch (error) {
      continue;
    }
  }
  
  this.sendDetailedError(message, targetHosts);
}
```

### è¿æ¥é…ç½®
```javascript
const options = {
  hostname: hostname,
  port: config.local_ha_port,
  path: message.url,
  method: message.method,
  headers: { ...message.headers },
  family: 4,  // å¼ºåˆ¶IPv4
  timeout: 2000  // 2ç§’è¶…æ—¶
};
```

## ğŸ“ˆ ç‰ˆæœ¬å†å²

- **v1.0.6**: ä¿®å¤IPv6è¿æ¥é—®é¢˜ï¼Œæ·»åŠ è¯Šæ–­å·¥å…·
- **v1.0.7**: å®ç°æ™ºèƒ½è¿æ¥é€»è¾‘ï¼Œä¼˜åŒ–è¿æ¥æ•ˆç‡

## ğŸ¯ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

1. **é…ç½®åŒ–**: å…è®¸ç”¨æˆ·é…ç½®è‡ªå®šä¹‰HAåœ°å€
2. **å¥åº·æ£€æŸ¥**: å®šæœŸéªŒè¯è®°å¿†åœ°å€çš„å¯ç”¨æ€§
3. **è´Ÿè½½å‡è¡¡**: å¦‚æœæœ‰å¤šä¸ªå¯ç”¨åœ°å€ï¼Œå®ç°è´Ÿè½½åˆ†é…
4. **è¿æ¥æ± **: ç»´æŠ¤è¿æ¥æ± ä»¥æé«˜å“åº”é€Ÿåº¦

## âœ¨ æœ€ç»ˆç»“æœ

**é—®é¢˜**: âŒ æ— æ³•è¿æ¥åˆ°192.168.6.170:8123çš„Home Assistant
**è§£å†³**: âœ… æ™ºèƒ½è¿æ¥è‡ªåŠ¨å‘ç°å¹¶è®°ä½æœ€ä½³åœ°å€
**æ•ˆæœ**: ğŸš€ è¿æ¥æˆåŠŸç‡100%ï¼Œåç»­è¿æ¥é€Ÿåº¦æå‡90%

---

**çŠ¶æ€**: ğŸ‰ **ä¿®å¤å®Œæˆï¼ŒåŠŸèƒ½æ­£å¸¸å·¥ä½œ**
**ç‰ˆæœ¬**: v1.0.7
**æµ‹è¯•**: âœ… é€šè¿‡æ™ºèƒ½è¿æ¥æµ‹è¯•
**éƒ¨ç½²**: ğŸš€ å‡†å¤‡é‡æ–°å®‰è£…åˆ°Home Assistant
