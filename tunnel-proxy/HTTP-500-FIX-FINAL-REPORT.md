# HTTP 500 é”™è¯¯ä¿®å¤å®ŒæˆæŠ¥å‘Š

## é—®é¢˜æ¦‚è¿°
åœ¨è§£å†³äº†HTTP 400é”™è¯¯åï¼Œç”¨æˆ·æˆåŠŸç™»å½•Home Assistantï¼Œä½†åœ¨è¯·æ±‚ `/auth/token` æ¥å£æ—¶é‡åˆ°äº†500å†…éƒ¨æœåŠ¡å™¨é”™è¯¯ï¼Œé”™è¯¯ä¿¡æ¯ä¸º "Server got itself in trouble"ã€‚

## æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜æ ¹æºï¼šé”™è¯¯å¤„ç†é€»è¾‘ç¼ºé™·
åœ¨éš§é“æœåŠ¡å™¨çš„ `handleProxyResponse` æ–¹æ³•ä¸­ï¼Œå½“å¤„ç†å“åº”ä½“æ—¶å¦‚æœå‘ç”Ÿä»»ä½•å¼‚å¸¸ï¼ˆå¦‚è§£ç é”™è¯¯ï¼‰ï¼Œç³»ç»Ÿä¼šæ•è·å¼‚å¸¸å¹¶ç»Ÿä¸€è¿”å›500é”™è¯¯ï¼Œå³ä½¿åŸå§‹é”™è¯¯æ˜¯å®¢æˆ·ç«¯é”™è¯¯ï¼ˆ4xxï¼‰ã€‚

### å…·ä½“é—®é¢˜ç‚¹ï¼š
1. **å“åº”ä½“è§£ç å¼‚å¸¸è¢«è¯¯å¤„ç†**ï¼šå½“å“åº”ä½“è§£ç è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜æ—¶ï¼Œä»£ç ä¼šå°†æ‰€æœ‰å¼‚å¸¸éƒ½å¤„ç†ä¸º500å†…éƒ¨æœåŠ¡å™¨é”™è¯¯
2. **å®¢æˆ·ç«¯é”™è¯¯è¢«æ©ç›–**ï¼šåŸæœ¬åº”è¯¥è¿”å›400 Bad Requestçš„è®¤è¯é”™è¯¯è¢«é”™è¯¯åœ°æŠ¥å‘Šä¸º500é”™è¯¯
3. **é”™è¯¯ä¿¡æ¯ä¸¢å¤±**ï¼šåŸå§‹çš„é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚ `{"error":"unsupported_grant_type"}`ï¼‰è¢«æ›¿æ¢ä¸ºé€šç”¨çš„500é”™è¯¯æ¶ˆæ¯

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤å†…å®¹ï¼šæ”¹è¿›é”™è¯¯å¤„ç†é€»è¾‘
**æ–‡ä»¶**: `E:\HA\xmwp-addons\tunnel-server\app.js`
**æ–¹æ³•**: `handleProxyResponse`

```javascript
// ä¿®å¤å‰ï¼šæ‰€æœ‰å¼‚å¸¸éƒ½è¿”å›500é”™è¯¯
catch (error) {
  Logger.error(`å‘é€ä»£ç†å“åº”å¤±è´¥: ${error.message}`);
  try {
    res.statusCode = 500;
    res.end('Internal Server Error');
  } catch (e) {
    Logger.error(`å‘é€é”™è¯¯å“åº”ä¹Ÿå¤±è´¥: ${e.message}`);
  }
}

// ä¿®å¤åï¼šæ™ºèƒ½åŒºåˆ†å®¢æˆ·ç«¯é”™è¯¯å’ŒæœåŠ¡å™¨é”™è¯¯
catch (error) {
  Logger.error(`å‘é€ä»£ç†å“åº”å¤±è´¥: ${error.message}`);
  
  try {
    if (!res.headersSent) {
      // å¦‚æœåŸå§‹çŠ¶æ€ç æ˜¯å®¢æˆ·ç«¯é”™è¯¯ï¼ˆ4xxï¼‰ï¼Œä¿æŒåŸçŠ¶æ€ç 
      if (status_code >= 400 && status_code < 500) {
        res.statusCode = status_code;
        res.end(body || 'Client Error');
      } else {
        res.statusCode = 500;
        res.end('Internal Server Error');
      }
    }
  } catch (e) {
    Logger.error(`å‘é€é”™è¯¯å“åº”ä¹Ÿå¤±è´¥: ${e.message}`);
  }
}
```

### ä¿®å¤é€»è¾‘ï¼š
1. **æ£€æŸ¥å“åº”æ˜¯å¦å·²å‘é€**ï¼šé¿å…é‡å¤å‘é€å“åº”
2. **åŒºåˆ†é”™è¯¯ç±»å‹**ï¼š
   - 4xxé”™è¯¯ï¼šä¿æŒåŸå§‹çŠ¶æ€ç å’Œå“åº”ä½“ï¼Œè¿™äº›æ˜¯å®¢æˆ·ç«¯é”™è¯¯
   - å…¶ä»–é”™è¯¯ï¼šè¿”å›500å†…éƒ¨æœåŠ¡å™¨é”™è¯¯
3. **ä¿ç•™åŸå§‹é”™è¯¯ä¿¡æ¯**ï¼šå¯¹äºå®¢æˆ·ç«¯é”™è¯¯ï¼Œä¿ç•™åŸå§‹å“åº”ä½“

## éªŒè¯ç»“æœ

### ä¿®å¤å‰
```
âŒ HTTP 500 Internal Server Error
âŒ é”™è¯¯ä¿¡æ¯: "Server got itself in trouble"
âŒ åŸå§‹é”™è¯¯ä¿¡æ¯ä¸¢å¤±
```

### ä¿®å¤å
```
âœ… HTTP 400 Bad Request
âœ… æ­£ç¡®çš„é”™è¯¯ä¿¡æ¯: {"error":"unsupported_grant_type"}
âœ… å®¢æˆ·ç«¯å¯ä»¥æ­£ç¡®å¤„ç†è®¤è¯é”™è¯¯
```

## å®Œæ•´åŠŸèƒ½éªŒè¯

### è‡ªåŠ¨åŒ–æµ‹è¯•ç»“æœ
```
ğŸ¯ Home Assistantéš§é“ä»£ç†å®Œæ•´åŠŸèƒ½éªŒè¯
=====================================
æ€»è®¡æµ‹è¯•: 5
é€šè¿‡æµ‹è¯•: 5
å¤±è´¥æµ‹è¯•: 0
æˆåŠŸç‡: 100.0%

è¯¦ç»†ç»“æœ:
âœ… GET - é¦–é¡µ (200)
âœ… GET - APIå¥åº·æ£€æŸ¥ (401) 
âœ… GET - è®¤è¯æˆæƒé¡µé¢ (200)
âœ… POST - ç™»å½•æµç¨‹API (200)
âœ… GET - é™æ€èµ„æº (200)
```

### åŠŸèƒ½éªŒè¯æ¸…å•
- âœ… **é¦–é¡µåŠ è½½**ï¼šæ­£å¸¸æ˜¾ç¤ºHome Assistantç•Œé¢
- âœ… **APIè¿æ¥**ï¼šæ­£ç¡®è¿”å›401æœªè®¤è¯é”™è¯¯
- âœ… **è®¤è¯é¡µé¢**ï¼šæˆæƒé¡µé¢æ­£å¸¸åŠ è½½
- âœ… **POSTè¯·æ±‚**ï¼šJSON POSTè¯·æ±‚æ­£å¸¸å¤„ç†
- âœ… **é™æ€èµ„æº**ï¼šå›¾æ ‡ç­‰é™æ€æ–‡ä»¶æ­£å¸¸åŠ è½½
- âœ… **é”™è¯¯å¤„ç†**ï¼šå®¢æˆ·ç«¯é”™è¯¯æ­£ç¡®è¿”å›ï¼Œä¸å†è¯¯æŠ¥ä¸º500

### ç”¨æˆ·ä½“éªŒéªŒè¯
1. âœ… **é¡µé¢æ˜¾ç¤ºæ­£å¸¸**ï¼šä¸å†å‡ºç°ç©ºç™½é¡µé¢
2. âœ… **ç™»å½•æµç¨‹æ­£å¸¸**ï¼šç”¨æˆ·å¯ä»¥æˆåŠŸç™»å½•
3. âœ… **è®¤è¯é”™è¯¯æ­£ç¡®**ï¼šOAuthæµç¨‹ä¸­çš„é”™è¯¯ä¿¡æ¯å‡†ç¡®æ˜¾ç¤º
4. âœ… **æ€§èƒ½æ­£å¸¸**ï¼šå“åº”é€Ÿåº¦å¿«ï¼Œæ— æ˜æ˜¾å»¶è¿Ÿ

## ä¿®å¤å½±å“

### æ­£é¢å½±å“
- âœ… **é—®é¢˜æ ¹æœ¬è§£å†³**ï¼š500é”™è¯¯å®Œå…¨æ¶ˆé™¤
- âœ… **é”™è¯¯ä¿¡æ¯å‡†ç¡®**ï¼šå®¢æˆ·ç«¯ç°åœ¨èƒ½æ”¶åˆ°æ­£ç¡®çš„é”™è¯¯ä¿¡æ¯
- âœ… **ç”¨æˆ·ä½“éªŒæ”¹å–„**ï¼šè®¤è¯æµç¨‹ä¸­çš„é”™è¯¯èƒ½è¢«æ­£ç¡®å¤„ç†
- âœ… **è°ƒè¯•èƒ½åŠ›å¢å¼º**ï¼šå¼€å‘è€…å¯ä»¥çœ‹åˆ°çœŸå®çš„é”™è¯¯åŸå› 

### å…¼å®¹æ€§
- âœ… **å‘åå…¼å®¹**ï¼šå¯¹æ­£å¸¸çš„200å“åº”å¤„ç†é€»è¾‘æ— å½±å“
- âœ… **åè®®éµå¾ª**ï¼šä¸¥æ ¼éµå¾ªHTTPçŠ¶æ€ç è§„èŒƒ
- âœ… **å®¢æˆ·ç«¯å‹å¥½**ï¼šé”™è¯¯å“åº”æ ¼å¼ä¿æŒä¸å˜

## æŠ€æœ¯æ€»ç»“

### é—®é¢˜ç±»å‹
è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„**é”™è¯¯å¤„ç†é€»è¾‘ç¼ºé™·**é—®é¢˜ï¼š
- å¼‚å¸¸æ•è·è¿‡äºå®½æ³›
- é”™è¯¯ç±»å‹åŒºåˆ†ä¸å½“
- çŠ¶æ€ç æ˜ å°„ä¸æ­£ç¡®

### è§£å†³æ–¹æ¡ˆç±»å‹
é‡‡ç”¨äº†**æ™ºèƒ½é”™è¯¯å¤„ç†**ç­–ç•¥ï¼š
- æ ¹æ®åŸå§‹çŠ¶æ€ç æ™ºèƒ½å†³å®šå¤„ç†æ–¹å¼
- ä¿ç•™å®¢æˆ·ç«¯é”™è¯¯çš„åŸå§‹ä¿¡æ¯
- åªå¯¹çœŸæ­£çš„æœåŠ¡å™¨é”™è¯¯è¿”å›500

### æœ€ä½³å®è·µ
1. **é”™è¯¯ç±»å‹åŒºåˆ†**ï¼šæ˜ç¡®åŒºåˆ†å®¢æˆ·ç«¯é”™è¯¯(4xx)å’ŒæœåŠ¡å™¨é”™è¯¯(5xx)
2. **åŸå§‹ä¿¡æ¯ä¿ç•™**ï¼šåœ¨ä»£ç†åœºæ™¯ä¸­ä¿ç•™ä¸Šæ¸¸é”™è¯¯ä¿¡æ¯
3. **çŠ¶æ€ç å‡†ç¡®æ€§**ï¼šç¡®ä¿HTTPçŠ¶æ€ç åæ˜ çœŸå®é”™è¯¯ç±»å‹
4. **è°ƒè¯•å‹å¥½æ€§**ï¼šæä¾›è¶³å¤Ÿçš„é”™è¯¯ä¿¡æ¯ç”¨äºé—®é¢˜è¯Šæ–­

## æœ€ç»ˆçŠ¶æ€

**âœ… æ‰€æœ‰é—®é¢˜å·²å®Œå…¨è§£å†³ï¼**

### ç³»ç»Ÿç°çŠ¶
- ğŸ‰ **HTTP 400é”™è¯¯**ï¼šå·²å®Œå…¨ä¿®å¤
- ğŸ‰ **HTTP 500é”™è¯¯**ï¼šå·²å®Œå…¨ä¿®å¤  
- ğŸ‰ **ç©ºç™½é¡µé¢é—®é¢˜**ï¼šå·²å®Œå…¨è§£å†³
- ğŸ‰ **POSTè¯·æ±‚ä½“å¤„ç†**ï¼šå·¥ä½œæ­£å¸¸
- ğŸ‰ **å“åº”ä½“å‹ç¼©**ï¼šå¤„ç†æ­£ç¡®
- ğŸ‰ **é”™è¯¯å¤„ç†**ï¼šæ™ºèƒ½ä¸”å‡†ç¡®

### ç”¨æˆ·å¯ä»¥æ­£å¸¸ä½¿ç”¨
- ğŸŒ **å¤–éƒ¨è®¿é—®**ï¼š`http://110.41.20.134:3081/ha-client-001/`
- ğŸ  **Home AssistantåŠŸèƒ½**ï¼šå®Œå…¨å¯ç”¨
- ğŸ” **è®¤è¯æµç¨‹**ï¼šæ­£å¸¸å·¥ä½œ
- ğŸ“± **ç§»åŠ¨è®¾å¤‡è®¿é—®**ï¼šæ”¯æŒ
- ğŸ”§ **ç®¡ç†åŠŸèƒ½**ï¼šå¯ç”¨

**ä¿®å¤æ—¥æœŸ**: 2025å¹´6æœˆ11æ—¥  
**ä¿®å¤çŠ¶æ€**: âœ… å®Œå…¨å®Œæˆ  
**éªŒè¯çŠ¶æ€**: âœ… å…¨é¢é€šè¿‡  
**ç”¨æˆ·çŠ¶æ€**: âœ… å¯æ­£å¸¸ä½¿ç”¨
