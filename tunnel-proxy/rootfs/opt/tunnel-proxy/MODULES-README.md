# 隧道代理服务 - 模块化重构

## 项目结构

```
tunnel-proxy/
├── app.js                 # 主应用入口
├── start.js              # 启动脚本
├── package.json          # 项目依赖
├── lib/                  # 核心模块目录
│   ├── config.js         # 配置管理模块
│   ├── logger.js         # 日志工具模块
│   ├── auth.js           # 身份验证模块
│   ├── tunnel-manager.js # 隧道连接管理模块
│   ├── proxy-server.js   # 代理服务器模块
│   ├── error-handler.js  # 错误处理模块
│   └── health-checker.js # 健康检查模块
├── tunnel-client.js      # 隧道客户端
└── public/               # 静态文件
```

## 模块说明

### 1. 主应用模块 (app.js)
- **职责**: 应用程序的主入口点，负责协调各个模块的启动和关闭
- **功能**: 
  - 初始化各个服务模块
  - 处理应用程序的生命周期
  - 协调服务的启动顺序

### 2. 配置管理模块 (lib/config.js)
- **职责**: 统一管理应用程序配置
- **功能**:
  - 加载配置文件
  - 验证配置的有效性
  - 提供配置访问接口
  - 支持开发环境和生产环境的不同配置

### 3. 日志工具模块 (lib/logger.js)
- **职责**: 提供统一的日志记录功能
- **功能**:
  - 支持不同级别的日志（info, warn, error, debug）
  - 格式化日志输出
  - 支持基于配置的日志级别控制

### 4. 身份验证模块 (lib/auth.js)
- **职责**: 处理用户身份验证和授权
- **功能**:
  - JWT token 生成和验证
  - 用户登录验证
  - 中间件形式的授权检查

### 5. 隧道管理模块 (lib/tunnel-manager.js)
- **职责**: 管理与中转服务器的隧道连接
- **功能**:
  - 建立和维护隧道连接
  - 处理代理请求转发
  - WebSocket 连接升级和数据转发
  - 智能主机选择和故障转移
  - 连接状态监控

### 6. 代理服务器模块 (lib/proxy-server.js)
- **职责**: 提供HTTP代理服务和Web管理界面
- **功能**:
  - 创建 Koa 应用和路由
  - HTTP 代理功能
  - REST API 接口
  - 静态文件服务
  - 连接管理

### 7. 错误处理模块 (lib/error-handler.js)
- **职责**: 统一处理应用程序错误和进程信号
- **功能**:
  - 全局错误捕获
  - 优雅关闭处理
  - 进程信号处理
  - 启动错误处理

### 8. 健康检查模块 (lib/health-checker.js)
- **职责**: 监控应用程序和服务的健康状态
- **功能**:
  - 系统健康状态检查
  - 定期健康检查任务
  - 本地 Home Assistant 连接测试
  - 性能监控（内存使用、连接状态等）

## 模块化的优势

### 1. 代码组织清晰
- 每个模块职责单一，功能明确
- 代码按功能分类，便于理解和维护
- 模块间依赖关系清晰

### 2. 可维护性提升
- 修改某个功能只需要关注对应的模块
- 降低了模块间的耦合度
- 便于单元测试和调试

### 3. 可扩展性增强
- 新功能可以作为独立模块添加
- 现有模块可以独立升级和优化
- 支持插件化扩展

### 4. 代码复用
- 模块可以在不同场景下复用
- 便于提取公共功能
- 支持模块的独立发布

## 使用方式

### 直接启动
```bash
node app.js
```

### 使用启动脚本
```bash
node start.js
```

### 开发模式
```bash
NODE_ENV=development node app.js
```

## 配置文件

### 开发环境
- 配置文件: `config-dev.json`
- 自动创建默认配置
- 支持热重载

### 生产环境
- 配置文件: `/data/options.json`
- Home Assistant Add-on 标准配置路径

## API 接口

### 认证相关
- `POST /api/auth/login` - 用户登录
- `GET /api/status` - 服务状态（需要认证）
- `GET /api/config` - 配置信息（需要认证）

### 健康检查
- `GET /api/health` - 健康状态检查

### 静态文件
- `GET /` - 重定向到管理界面
- `GET /index.html` - 管理界面

## 依赖管理

所有模块的依赖都在 `package.json` 中统一管理：

```json
{
  "dependencies": {
    "@koa/cors": "^4.0.0",
    "axios": "^1.6.0",
    "http-proxy": "^1.18.1",
    "jsonwebtoken": "^9.0.2",
    "koa": "^2.14.2",
    "koa-bodyparser": "^4.4.1",
    "koa-router": "^12.0.0",
    "koa-static": "^5.0.0",
    "ws": "^8.14.2"
  }
}
```

## 注意事项

1. **模块加载顺序**: 配置模块必须在其他模块之前加载
2. **错误处理**: 所有模块都应该使用统一的错误处理机制
3. **日志记录**: 使用统一的日志工具，避免直接使用 console
4. **配置访问**: 通过配置模块的接口访问配置，避免直接读取配置文件
