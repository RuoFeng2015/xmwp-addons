# HTTP 400 é”™è¯¯ä¿®å¤å®ŒæˆæŠ¥å‘Š

## é—®é¢˜æ¦‚è¿°
Home Assistantå†…ç½‘éš§é“è§£å†³æ–¹æ¡ˆå‡ºç°HTTP 400 "Bad Request"é”™è¯¯ï¼Œå¤–éƒ¨è¯·æ±‚ `http://110.41.20.134:3081/ha-client-001/` è¿”å›HTTP 400ï¼Œå“åº”ä½“ä¸ºç©ºçš„JSONå¯¹è±¡ `b'{}'`ã€‚

## æ ¹æœ¬åŸå› åˆ†æ
é€šè¿‡è¯¦ç»†çš„è°ƒè¯•å’Œåˆ†æï¼Œå‘ç°äº†ä»¥ä¸‹é—®é¢˜ï¼š

### 1. ä¸»è¦é—®é¢˜ï¼šé”™è¯¯çš„è¯·æ±‚ä½“å¤„ç†
- **é—®é¢˜**ï¼šéš§é“æœåŠ¡å™¨å¯¹GETè¯·æ±‚é”™è¯¯åœ°å‘é€äº†ç©ºJSONå¯¹è±¡ `{}` ä½œä¸ºè¯·æ±‚ä½“
- **åŸå› **ï¼šKoaçš„body parserå°† `ctx.request.body` è®¾ç½®ä¸ºç©ºå¯¹è±¡ï¼Œä»£ç é”™è¯¯åœ°å°†å…¶åºåˆ—åŒ–å¹¶å‘é€
- **å½±å“**ï¼šHome Assistantæ‹’ç»å¸¦æœ‰è¯·æ±‚ä½“çš„GETè¯·æ±‚ï¼Œè¿”å›400é”™è¯¯

### 2. æ¬¡è¦é—®é¢˜ï¼šJSONæ¶ˆæ¯è§£æé”™è¯¯
- **é—®é¢˜**ï¼šç½‘ç»œä¼ è¾“çš„æ¶ˆæ¯åˆ†ç‰‡å¯¼è‡´JSONè§£æå¤±è´¥
- **é”™è¯¯ä¿¡æ¯**ï¼š`Unexpected token 'v', "vg\" viewB"... is not valid JSON`
- **åŸå› **ï¼šç¼ºä¹æ¶ˆæ¯ç¼“å†²æœºåˆ¶å¤„ç†ä¸å®Œæ•´çš„æ¶ˆæ¯

### 3. å·²ç¡®è®¤Hostå¤´å¤„ç†æ­£ç¡®
- âœ… éš§é“æœåŠ¡å™¨æ­£ç¡®åˆ é™¤äº†æœ‰é—®é¢˜çš„Hostå¤´
- âœ… å®¢æˆ·ç«¯æ­£ç¡®è®¾ç½®äº†ç›®æ ‡Hostå¤´ `192.168.6.170:8123`

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šè¯·æ±‚ä½“å¤„ç†ä¼˜åŒ–
**æ–‡ä»¶**: `E:\HA\xmwp-addons\tunnel-server\app.js`
**ä½ç½®**: `forwardRequest` æ–¹æ³•

```javascript
// ä¿®å¤å‰ï¼šé”™è¯¯åœ°å‘é€ç©ºå¯¹è±¡ä½œä¸ºè¯·æ±‚ä½“
if (ctx.request.body) {
  const bodyString = typeof ctx.request.body === 'string'
    ? ctx.request.body
    : JSON.stringify(ctx.request.body);
  req._dataHandlers.forEach(handler => handler(bodyString));
}

// ä¿®å¤åï¼šåªåœ¨æœ‰å®é™…å†…å®¹æ—¶æ‰å‘é€è¯·æ±‚ä½“
if (ctx.request.body && 
    ctx.request.body !== null && 
    ctx.request.body !== undefined &&
    !(typeof ctx.request.body === 'object' && Object.keys(ctx.request.body).length === 0)) {
  const bodyString = typeof ctx.request.body === 'string'
    ? ctx.request.body
    : JSON.stringify(ctx.request.body);
  req._dataHandlers.forEach(handler => handler(bodyString));
  Logger.debug(`Forwarding request body: ${bodyString.length} bytes`);
} else {
  Logger.debug('No request body to forward (GET request or empty body)');
}
```

### ä¿®å¤2ï¼šæ¶ˆæ¯ç¼“å†²æœºåˆ¶
**æ–‡ä»¶**: `E:\HA\xmwp-addons\tunnel-server\app.js`
**ä½ç½®**: `handleClientMessage` æ–¹æ³•

```javascript
// æ·»åŠ æ¶ˆæ¯ç¼“å†²åŒºåˆ°å®¢æˆ·ç«¯ä¿¡æ¯
const clientInfo = {
  // ...å…¶ä»–å±æ€§...
  messageBuffer: '' // æ–°å¢ç¼“å†²åŒº
};

// æ”¹è¿›çš„æ¶ˆæ¯å¤„ç†é€»è¾‘
handleClientMessage(clientInfo, data) {
  try {
    // å°†æ–°æ•°æ®æ·»åŠ åˆ°ç¼“å†²åŒº
    clientInfo.messageBuffer += data.toString();
    
    // å¤„ç†å®Œæ•´çš„æ¶ˆæ¯ï¼ˆä»¥æ¢è¡Œç¬¦åˆ†éš”ï¼‰
    const lines = clientInfo.messageBuffer.split('\n');
    
    // ä¿ç•™æœ€åä¸€ä¸ªå¯èƒ½ä¸å®Œæ•´çš„æ¶ˆæ¯
    clientInfo.messageBuffer = lines.pop() || '';
    
    // å¤„ç†å®Œæ•´çš„æ¶ˆæ¯
    for (const messageStr of lines) {
      if (messageStr.trim()) {
        try {
          const message = JSON.parse(messageStr);
          // å¤„ç†æ¶ˆæ¯...
        } catch (parseError) {
          Logger.error(`JSONè§£æå¤±è´¥: ${parseError.message}, æ¶ˆæ¯å†…å®¹: ${messageStr.substring(0, 100)}...`);
        }
      }
    }
  } catch (error) {
    Logger.error(`å¤„ç†å®¢æˆ·ç«¯æ¶ˆæ¯å¤±è´¥: ${error.message}`);
    clientInfo.messageBuffer = ''; // æ¸…ç©ºç¼“å†²åŒº
  }
}
```

## éªŒè¯ç»“æœ

### ä¿®å¤å‰
```
âŒ HTTP 400 Bad Request
âŒ å“åº”ä½“: b'{}'
âŒ é”™è¯¯ä¿¡æ¯: Data after `Connection: close`: b'{}'
```

### ä¿®å¤å
```
âœ… HTTP 200 OK
âœ… å“åº”ä½“: å®Œæ•´çš„Home Assistant HTMLé¡µé¢ (5495 bytes)
âœ… å†…å®¹ç±»å‹: text/html; charset=utf-8
âœ… æµè§ˆå™¨å¯æ­£å¸¸è®¿é—®: http://110.41.20.134:3081/ha-client-001/
```

## æµ‹è¯•éªŒè¯

### è‡ªåŠ¨åŒ–æµ‹è¯•ç»“æœ
```
ğŸ§ª æµ‹è¯•: GET æ ¹è·¯å¾„
   è¯·æ±‚: GET /ha-client-001/
   å“åº”: 200 OK
   ç»“æœ: âœ… é€šè¿‡

ğŸ“Š æµ‹è¯•æ€»ç»“
âœ… æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•é€šè¿‡
âœ… éš§é“ä»£ç†æ­£å¸¸å·¥ä½œ
âœ… Home Assistantå¯é€šè¿‡å¤–éƒ¨ç½‘ç»œè®¿é—®
```

### æ‰‹åŠ¨éªŒè¯
1. âœ… æµè§ˆå™¨è®¿é—®ï¼š`http://110.41.20.134:3081/ha-client-001/`
2. âœ… æ˜¾ç¤ºå®Œæ•´çš„Home Assistantç™»å½•ç•Œé¢
3. âœ… é¡µé¢åŠ è½½æ­£å¸¸ï¼Œæ— 400é”™è¯¯
4. âœ… é™æ€èµ„æºï¼ˆCSS/JSï¼‰æ­£å¸¸åŠ è½½

## ä¿®å¤å½±å“

### æ­£é¢å½±å“
- âœ… **è§£å†³æ ¸å¿ƒé—®é¢˜**ï¼šHTTP 400é”™è¯¯å®Œå…¨æ¶ˆé™¤
- âœ… **æé«˜ç¨³å®šæ€§**ï¼šæ¶ˆæ¯ç¼“å†²æœºåˆ¶é˜²æ­¢JSONè§£æé”™è¯¯
- âœ… **ä¿æŒå…¼å®¹æ€§**ï¼šæ‰€æœ‰ç°æœ‰åŠŸèƒ½ç»§ç»­æ­£å¸¸å·¥ä½œ
- âœ… **æ”¹å–„ç”¨æˆ·ä½“éªŒ**ï¼šå¤–éƒ¨ç½‘ç»œå¯æ­£å¸¸è®¿é—®Home Assistant

### é£é™©è¯„ä¼°
- âœ… **ä½é£é™©**ï¼šä¿®æ”¹ä»…æ¶‰åŠé”™è¯¯å¤„ç†é€»è¾‘
- âœ… **å‘åå…¼å®¹**ï¼šä¸å½±å“ç°æœ‰å®¢æˆ·ç«¯è¿æ¥
- âœ… **å¯å›æ»š**ï¼šä¿®æ”¹å±€éƒ¨ä¸”å¯é€†

## åç»­å»ºè®®

### 1. ç›‘æ§å’Œæ—¥å¿—
- å»ºè®®ä¿æŒDEBUGæ—¥å¿—çº§åˆ«è¿è¡Œä¸€æ®µæ—¶é—´
- ç›‘æ§æ˜¯å¦æœ‰æ–°çš„JSONè§£æé”™è¯¯
- å®šæœŸæ£€æŸ¥éš§é“è¿æ¥ç¨³å®šæ€§

### 2. è¿›ä¸€æ­¥ä¼˜åŒ–
- è€ƒè™‘æ·»åŠ è¯·æ±‚é‡è¯•æœºåˆ¶
- ä¼˜åŒ–è¶…æ—¶å¤„ç†
- æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯æŠ¥å‘Š

### 3. æ–‡æ¡£æ›´æ–°
- æ›´æ–°æ•…éšœæ’é™¤æ–‡æ¡£
- è®°å½•ä¿®å¤è¿‡ç¨‹ä¾›æœªæ¥å‚è€ƒ

## æ€»ç»“

**HTTP 400 "Bad Request" é”™è¯¯å·²å®Œå…¨ä¿®å¤ï¼** ğŸ‰

æ ¸å¿ƒé—®é¢˜æ˜¯éš§é“æœåŠ¡å™¨é”™è¯¯åœ°ä¸ºGETè¯·æ±‚å‘é€äº†ç©ºJSONå¯¹è±¡ä½œä¸ºè¯·æ±‚ä½“ï¼Œå¯¼è‡´Home Assistantè¿”å›400é”™è¯¯ã€‚é€šè¿‡ä¼˜åŒ–è¯·æ±‚ä½“å¤„ç†é€»è¾‘å’Œæ·»åŠ æ¶ˆæ¯ç¼“å†²æœºåˆ¶ï¼Œç°åœ¨éš§é“ä»£ç†å·¥ä½œæ­£å¸¸ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡å¤–éƒ¨ç½‘ç»œ `http://110.41.20.134:3081/ha-client-001/` æˆåŠŸè®¿é—®Home Assistantã€‚

**ä¿®å¤æ—¥æœŸ**: 2025å¹´6æœˆ11æ—¥  
**ä¿®å¤çŠ¶æ€**: âœ… å®Œæˆ  
**éªŒè¯çŠ¶æ€**: âœ… é€šè¿‡
